<?php

// 
// print_r(WGR_BASE_PATH);

// 
// $eb_cache_php = ABSPATH . 'wp-content/webgiareorg/eb_cache.php';
// if (is_file($eb_cache_php)) {
if (defined('EB_THEME_CACHE')) {
    $root_dir_cache = dirname(EB_THEME_CACHE);
} else {
    $root_dir_cache = ABSPATH . 'wp-content/uploads/ebcache';

    // 
    // include $eb_cache_php;
}
// $root_dir_cache = dirname(EB_THEME_CACHE);
// print_r($root_dir_cache);
// }

// 
if (defined('EB_MY_CACHE_CONFIG')) {
    $my_config_php = EB_MY_CACHE_CONFIG;
} else {
    $my_config_php = $root_dir_cache . '/my-config.php';
}
// echo $my_config_php . '<br>' . PHP_EOL;
$my_config_content = '';
if (is_file($my_config_php)) {
    $my_config_content = 'N·ªôi dung n√†y ch·ªâ coder m·ªõi c√≥ th·ªÉ xem!';
    // $my_config_content = file_get_contents($my_config_php);
}


?>
<h1>C·∫•u h√¨nh website</h1>
<h2><?php echo str_replace(ABSPATH, '', $my_config_php); ?></h2>
<div class="text-center w99">
    <textarea rows="<?php echo count(explode("\n", $my_config_content)); ?>" class="large-text code" placeholder="My config content" readonly disabled><?php echo esc_html($my_config_content); ?></textarea>
</div>
<br>
<!-- Cleanup site cache -->
<?php

// x√≥a cache khi ch·∫°y qua ph∆∞∆°ng th·ª©c POST (ch·ªâ khi kh√¥ng ph·∫£i save robots)
if (isset($_POST['cleanup_cache']) && wp_verify_nonce($_POST['_wpnonce_cleanup_cache'], 'cleanup_cache_action')) {
    // x√≥a cache theo redis n·∫øu c√≥
    if (is_file($my_config_php)) {
        include $my_config_php;

        // 
        if (defined('EB_REDIS_CACHE') && EB_REDIS_CACHE == true && !empty(phpversion('redis'))) {
            // print_r(EB_REDIS_CACHE);

            // 
            try {
                $rd = new Redis();
                $rd->connect(WGR_REDIS_HOST, WGR_REDIS_PORT);

                // ch·ªâ l·∫•y cache theo prefix c·ªßa t·ª´ng t√™n mi·ªÅn
                if (defined('WGR_CACHE_PREFIX')) {
                    $cache_prefix = WGR_CACHE_PREFIX;
                } else {
                    $cache_prefix = strtolower(str_replace([
                        'www.',
                        '.'
                    ], '', str_replace('-', '_', explode(':', $_SERVER['HTTP_HOST'])[0])));
                }
                $cache_prefix .= '*';
                echo 'Cache prefix: ' . $cache_prefix . '<br>' . PHP_EOL;

                // 
                $keys = $rd->keys($cache_prefix);
                // print_r($keys);
                if ($keys) {
                    $rd->del($keys);
                }
            } catch (Exception $e) {
                echo $e->getMessage();
            }
        } else {
            echo 'no redis' . '<br>' . PHP_EOL;
        }
    } else {
        echo 'No config file: ' . $my_config_php . '<br>' . PHP_EOL;
    }

    // xong m·ªõi x√≥a cache trong file
    echo 'X√≥a cache trong th∆∞ m·ª•c: ' . $root_dir_cache . '<br>' . PHP_EOL;
    WGR_deleteDirectory($root_dir_cache);
}

?>
<h2>Cleanup site cache</h2>
<form action="" method="post" onsubmit="return confirm('Cleanup all site cache?');">
    <?php wp_nonce_field('cleanup_cache_action', '_wpnonce_cleanup_cache'); ?>
    <button type="submit" name="cleanup_cache" class="button button-primary button-large">D·ªçn d·∫πp WGR Cache</button>
</form>
<br>
<!-- END Cleanup site cache -->

<hr>

<!-- WGR Options Form -->
<?php
// X·ª≠ l√Ω l∆∞u options
if (isset($_POST['save_wgr_options']) && wp_verify_nonce($_POST['_wpnonce_wgr_options'], 'save_wgr_options_action')) {
    $options_to_save = [
        'wgr_advanced_cache' => isset($_POST['wgr_advanced_cache']) ? '1' : '0',
        'wgr_term_description_order' => isset($_POST['wgr_term_description_order']) ? '1' : '0',
        'wgr_contact_price' => sanitize_text_field($_POST['wgr_contact_price'] ?? ''),
        'wgr_add_font_awesome' => sanitize_text_field($_POST['wgr_add_font_awesome'] ?? '0'),
        // CDN
        'cdn_base_url' => esc_url_raw($_POST['cdn_base_url'] ?? ''),
        'eb_cdn_uploads_url' => esc_url_raw($_POST['eb_cdn_uploads_url'] ?? ''),
    ];

    $success_count = 0;
    $wgr_config_path = WGR_CHILD_PATH . 'custom_config.php';
    file_put_contents($wgr_config_path, implode(PHP_EOL, [
        '<?php',
        '',
        '/**',
        ' * Custom config file',
        ' * Do not edit this file manually, changes will be overwritten when saving options from admin panel.',
        ' *',
        ' * @package WebGiaRe',
        ' * @link https://webgiare.org',
        ' * @license GNU General Public License v2 or later (GPLv2+)',
        ' * Generated on ' . date_i18n('Y-m-d H:i:s'),
        ' * From ' . $_SERVER['REQUEST_URI'],
        ' *',
        ' */',
        '',
    ]) . PHP_EOL, LOCK_EX);
    foreach ($options_to_save as $option_name => $option_value) {
        if (update_option($option_name, $option_value)) {
            $success_count++;
        }

        // X√≥a c√°c file li√™n quan khi thay ƒë·ªïi c·∫•u h√¨nh cache
        if ($option_name == 'wgr_advanced_cache') {
            if (empty($option_value)) {
                // x√≥a file object-cache.php trong wp-content n·∫øu c√≥
                if (
                    is_file(ABSPATH . 'wp-content/object-cache.php') &&
                    // ƒë·∫£m b·∫£o file n√†y ƒë∆∞·ª£c t·∫°o ra b·ªüi plugin webgiareorg
                    strpos(file_get_contents(ABSPATH . 'wp-content/object-cache.php'), '/webgiareorg/') !== false
                ) {
                    unlink(ABSPATH . 'wp-content/object-cache.php');
                }
            } else if (
                defined('WGR_REDIS_CACHE') &&
                WGR_REDIS_CACHE === true &&
                defined('WGR_CACHE_PREFIX') &&
                !empty(WGR_CACHE_PREFIX)
            ) {
                // t·∫°o file ƒë·ªÉ include file object-cache thay v√¨ copy -> t·∫≠n d·ª•ng ƒë∆∞·ª£c code khi update
                file_put_contents(ABSPATH . 'wp-content/object-cache.php', implode(PHP_EOL, [
                    '<?php',
                    '',
                    '/**',
                    ' * Simple Redis Object Cache',
                    ' *',
                    ' * @package WebGiaRe',
                    ' * @link https://webgiare.org',
                    ' * @license GNU General Public License v2 or later (GPLv2+)',
                    ' * Generated on ' . date_i18n('Y-m-d H:i:s'),
                    ' * From ' . $_SERVER['REQUEST_URI'],
                    ' *',
                    ' */',
                    '',
                    '// Prevent direct access',
                    'if (!defined(\'ABSPATH\')) {',
                    '    exit;',
                    '}',
                    '',
                    'include_once __DIR__ . \'/webgiareorg/app/Cache/object-cache.php\';',
                    '',
                ]), LOCK_EX);
            }
        }

        // c√°c tr∆∞·ªùng ch·ªâ ghi khi c√≥ gi√° tr·ªã
        if (empty($option_value)) {
            continue;
        } else if ($option_name == 'cdn_base_url') {
            // N·∫øu kh√¥ng ph·∫£i l√† URL h·ª£p l·ªá ho·∫∑c tr√πng v·ªõi gi√° tr·ªã m·∫∑c ƒë·ªãnh th√¨ b·ªè qua
            if (strpos($option_value, '//') === false || $option_value == DYNAMIC_BASE_URL) {
                continue;
            }
            $option_value = rtrim($option_value, '/') . '/';
        } else if ($option_name == 'eb_cdn_uploads_url') {
            // N·∫øu kh√¥ng ph·∫£i l√† URL h·ª£p l·ªá ho·∫∑c tr√πng v·ªõi gi√° tr·ªã m·∫∑c ƒë·ªãnh th√¨ b·ªè qua
            if (strpos($option_value, '//') === false) {
                continue;
            }
            $option_value = rtrim($option_value, '/') . '/';
        }

        // Ghi v√†o file config
        file_put_contents($wgr_config_path, 'define(\'' . strtoupper($option_name) . '\', \'' . $option_value . '\');' . PHP_EOL, FILE_APPEND);
    }

    if ($success_count > 0) {
        echo '<div class="notice notice-success"><p>ƒê√£ l∆∞u ' . $success_count . ' options th√†nh c√¥ng!</p></div>';
    } else {
        echo '<div class="notice notice-info"><p>Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë∆∞·ª£c l∆∞u.</p></div>';
    }
}

// L·∫•y gi√° tr·ªã hi·ªán t·∫°i c·ªßa options
$wgr_advanced_cache = get_option('wgr_advanced_cache', '0');
$wgr_term_description_order = get_option('wgr_term_description_order', '0');
$wgr_contact_price = get_option('wgr_contact_price', '');
$wgr_add_font_awesome = get_option('wgr_add_font_awesome', '0');
$cdn_base_url = get_option('cdn_base_url', '');
$eb_cdn_uploads_url = get_option('eb_cdn_uploads_url', '');
?>
<h2>Custom Config</h2>
<form action="" method="post">
    <?php wp_nonce_field('save_wgr_options_action', '_wpnonce_wgr_options'); ?>

    <table class="form-table" role="presentation">
        <tbody>
            <tr>
                <th scope="row">WGR Advanced Cache</th>
                <td>
                    <fieldset>
                        <label>
                            <input type="checkbox" name="wgr_advanced_cache" value="1" <?php checked($wgr_advanced_cache, '1'); ?>>
                            S·ª≠ d·ª•ng WGR Advanced Cache (khuy√™n d√πng)
                        </label>
                        <p class="description">ƒê∆∞·ª£c t·ªëi ∆∞u ri√™ng cho code c·ªßa WebGiaRe.</p>
                    </fieldset>
                </td>
            </tr>

            <tr>
                <th scope="row">Term description</th>
                <td>
                    <fieldset>
                        <label>
                            <input type="checkbox" name="wgr_term_description_order" value="1" <?php checked($wgr_term_description_order, '1'); ?>>
                            To bottom of the page
                        </label>
                        <p class="description">Chuy·ªÉn m√¥ t·∫£ danh m·ª•c xu·ªëng cu·ªëi trang.</p>
                    </fieldset>
                </td>
            </tr>

            <tr>
                <th scope="row">
                    <label for="wgr_contact_price">Contact Price</label>
                </th>
                <td>
                    <input type="url" name="wgr_contact_price" id="wgr_contact_price" value="<?php echo esc_attr($wgr_contact_price); ?>" class="regular-text" placeholder="Li√™n h·ªá">
                    <p class="description">Chuy·ªÉn gi√° s·∫£n ph·∫©m t·ª´ `0 ƒë` th√†nh `Li√™n h·ªá`. ƒê·ªÉ tr·ªëng s·∫Ω t·∫Øt ch·ª©c nƒÉng n√†y.</p>
                </td>
            </tr>

            <tr>
                <th scope="row">
                    <label for="wgr_add_font_awesome">Font Awesome Version</label>
                </th>
                <td>
                    <select name="wgr_add_font_awesome" id="wgr_add_font_awesome" class="regular-text">
                        <option value="0" <?php selected($wgr_add_font_awesome, '0'); ?>>Kh√¥ng s·ª≠ d·ª•ng</option>
                        <option value="4" <?php selected($wgr_add_font_awesome, '4'); ?>>Font Awesome 4</option>
                        <option value="5" <?php selected($wgr_add_font_awesome, '5'); ?>>Font Awesome 5</option>
                        <option value="6" <?php selected($wgr_add_font_awesome, '6'); ?>>Font Awesome 6</option>
                    </select>
                    <p class="description">Ch·ªçn phi√™n b·∫£n Font Awesome ƒë·ªÉ s·ª≠ d·ª•ng tr√™n website. Ch·ªâ k√≠ch ho·∫°t khi c√≥ n·ªôi dung s·ª≠ d·ª•ng Font Awesome v√† kh√¥ng c√≥ plugin n√†o n·∫°p font t∆∞∆°ng t·ª± ƒë·ªÉ nh·∫π website.</p>
                </td>
            </tr>

            <tr>
                <th scope="row">
                    <label for="cdn_base_url">CDN Base URL</label>
                </th>
                <td>
                    <input type="url" name="cdn_base_url" id="cdn_base_url" value="<?php echo esc_attr($cdn_base_url); ?>" class="regular-text" placeholder="https://cdn.example.com">
                    <p class="description">Nh·∫≠p URL c·ªßa CDN ƒë·ªÉ s·ª≠ d·ª•ng cho c√°c t√†i nguy√™n tƒ©nh.</p>
                </td>
            </tr>

            <tr>
                <th scope="row">
                    <label for="eb_cdn_uploads_url">CDN Uploads URL</label>
                </th>
                <td>
                    <input type="url" name="eb_cdn_uploads_url" id="eb_cdn_uploads_url" value="<?php echo esc_attr($eb_cdn_uploads_url); ?>" class="regular-text" placeholder="https://media.example.com">
                    <p class="description">Nh·∫≠p URL c·ªßa CDN ƒë·ªÉ s·ª≠ d·ª•ng cho c√°c t√†i nguy√™n tƒ©nh trong th∆∞ m·ª•c uploads.</p>
                </td>
            </tr>
        </tbody>
    </table>

    <p class="submit">
        <button type="submit" name="save_wgr_options" class="button button-primary button-large">L∆∞u Options</button>
    </p>
</form>
<!-- END WGR Options Form -->

<hr>

<!-- Object Cache Statistics -->
<?php
global $wp_object_cache, $wpdb;

// Get cache stats
$redis_connected = false;
$cache_hits = 0;
$cache_misses = 0;
$hit_ratio = 0;

if (is_object($wp_object_cache)) {
    // Use reflection to get private properties
    $reflection = new ReflectionClass($wp_object_cache);

    // Get redis_connected status
    if ($reflection->hasProperty('redis_connected')) {
        $redis_prop = $reflection->getProperty('redis_connected');
        $redis_prop->setAccessible(true);
        $redis_connected = $redis_prop->getValue($wp_object_cache);
    }

    if ($reflection->hasProperty('cache_hits')) {
        $hits_prop = $reflection->getProperty('cache_hits');
        $hits_prop->setAccessible(true);
        $cache_hits = $hits_prop->getValue($wp_object_cache);
    }

    if ($reflection->hasProperty('cache_misses')) {
        $misses_prop = $reflection->getProperty('cache_misses');
        $misses_prop->setAccessible(true);
        $cache_misses = $misses_prop->getValue($wp_object_cache);
    }

    $total_requests = $cache_hits + $cache_misses;
    if ($total_requests > 0) {
        $hit_ratio = ($cache_hits / $total_requests) * 100;
    }
}

// Get database query count
$db_queries = $wpdb->num_queries;
$db_query_time = 0;
if (defined('SAVEQUERIES') && SAVEQUERIES && !empty($wpdb->queries)) {
    foreach ($wpdb->queries as $query) {
        $db_query_time += $query[1];
    }
}
?>
<h2>Object Cache & Database Statistics</h2>
<table class="widefat striped">
    <thead>
        <tr>
            <th colspan="2">Cache Performance</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Redis Status:</strong></td>
            <td>
                <?php if ($redis_connected): ?>
                    <span style="color: green;">‚úì Connected</span>
                    <?php if (defined('WGR_CACHE_PREFIX')): ?>
                        (Prefix: <code><?php echo WGR_CACHE_PREFIX; ?></code>)
                    <?php endif; ?>
                <?php else: ?>
                    <span style="color: red;">‚úó Not Connected</span>
                    <?php if (!defined('WGR_REDIS_CACHE') || WGR_REDIS_CACHE !== true): ?>
                        - <em>WGR_REDIS_CACHE is not enabled</em>
                    <?php elseif (!defined('WGR_CACHE_PREFIX') || empty(WGR_CACHE_PREFIX)): ?>
                        - <em>WGR_CACHE_PREFIX is not set</em>
                    <?php elseif (!class_exists('Redis')): ?>
                        - <em>Redis class is not available</em>
                    <?php endif; ?>
                <?php endif; ?>
            </td>
        </tr>
        <tr>
            <td><strong>Cache Hits:</strong></td>
            <td><?php echo number_format($cache_hits); ?></td>
        </tr>
        <tr>
            <td><strong>Cache Misses:</strong></td>
            <td><?php echo number_format($cache_misses); ?></td>
        </tr>
        <tr>
            <td><strong>Hit Ratio:</strong></td>
            <td>
                <strong style="color: <?php echo $hit_ratio >= 80 ? 'green' : ($hit_ratio >= 50 ? 'orange' : 'red'); ?>;">
                    <?php echo number_format($hit_ratio, 2); ?>%
                </strong>
                <?php if ($hit_ratio >= 80): ?>
                    <span style="color: green;">‚úì Excellent</span>
                <?php elseif ($hit_ratio >= 50): ?>
                    <span style="color: orange;">‚ö† Good</span>
                <?php else: ?>
                    <span style="color: red;">‚úó Poor</span>
                <?php endif; ?>
            </td>
        </tr>
        <tr>
            <td><strong>Total Cache Requests:</strong></td>
            <td><?php echo number_format($cache_hits + $cache_misses); ?></td>
        </tr>
    </tbody>
</table>
<br>
<table class="widefat striped">
    <thead>
        <tr>
            <th colspan="2">Database Performance</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>Total Queries:</strong></td>
            <td>
                <strong style="color: <?php echo $db_queries < 50 ? 'green' : ($db_queries < 100 ? 'orange' : 'red'); ?>;">
                    <?php echo number_format($db_queries); ?>
                </strong>
                <?php if ($db_queries < 50): ?>
                    <span style="color: green;">‚úì Excellent</span>
                <?php elseif ($db_queries < 100): ?>
                    <span style="color: orange;">‚ö† Acceptable</span>
                <?php else: ?>
                    <span style="color: red;">‚úó Too many queries!</span>
                <?php endif; ?>
            </td>
        </tr>
        <?php if ($db_query_time > 0): ?>
            <tr>
                <td><strong>Query Time:</strong></td>
                <td><?php echo number_format($db_query_time, 4); ?> seconds</td>
            </tr>
        <?php endif; ?>
    </tbody>
</table>
<br>
<div class="notice notice-info">
    <p><strong>üí° Tips ƒë·ªÉ t·ªëi ∆∞u cache:</strong></p>
    <ul>
        <li><strong>Hit Ratio &gt; 80%</strong> l√† r·∫•t t·ªët - nghƒ©a l√† cache ƒëang ho·∫°t ƒë·ªông hi·ªáu qu·∫£</li>
        <li><strong>Database Queries &lt; 50</strong> l√† l√Ω t∆∞·ªüng cho m·ªôt page</li>
        <li>ƒê·ªÉ xem chi ti·∫øt queries, th√™m <code>define('SAVEQUERIES', true);</code> v√†o wp-config.php</li>
        <li>Reload trang nhi·ªÅu l·∫ßn ƒë·ªÉ th·∫•y cache hits tƒÉng l√™n</li>
    </ul>
</div>
<?php if (!defined('SAVEQUERIES') || !SAVEQUERIES): ?>
    <div class="notice notice-warning">
        <p><strong>‚ö† ƒê·ªÉ xem chi ti·∫øt query time:</strong></p>
        <p>Th√™m d√≤ng sau v√†o <code>wp-config.php</code>:</p>
        <pre>define('SAVEQUERIES', true);</pre>
    </div>
<?php endif; ?>

<?php if (!$redis_connected && (!defined('WGR_REDIS_CACHE') || WGR_REDIS_CACHE !== true)): ?>
    <div class="notice notice-error">
        <p><strong>‚ö† Object Cache ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t!</strong></p>
        <p>ƒê·ªÉ k√≠ch ho·∫°t Redis Object Cache, th√™m v√†o <code>wp-config.php</code>:</p>
        <pre>define('WGR_REDIS_CACHE', true);
define('WGR_CACHE_PREFIX', 'mysite_');
define('WGR_REDIS_HOST', '127.0.0.1');
define('WGR_REDIS_PORT', 6379);</pre>
    </div>
<?php endif; ?>
<br>
<!-- END Object Cache Statistics -->

<hr>

<!-- Edit robots.txt -->
<?php
// Logic l·∫•y n·ªôi dung robots.txt
$robots_content = '';
$robots_base_content = '';
$robots_main_path = ABSPATH . 'robots.txt';
$robots_child_path = WGR_CHILD_PATH . 'tmp/robots.txt';
$robots_base_path = WGR_BASE_PATH . 'tmp/robots.txt';

// ∆Øu ti√™n l·∫•y t·ª´ ABSPATH tr∆∞·ªõc
if (is_file($robots_main_path)) {
    $robots_content = file_get_contents($robots_main_path);
} elseif (is_file($robots_child_path)) {
    $robots_content = file_get_contents($robots_child_path);
} else {
    $robots_base_content = trim(file_get_contents($robots_base_path));
    $robots_content = $robots_base_content;
}

// X·ª≠ l√Ω form submit
if (isset($_POST['save_robots']) && wp_verify_nonce($_POST['_wpnonce_robots'], 'save_robots_action')) {
    $new_robots_content = stripslashes($_POST['robots_content']);
    if (empty($new_robots_content)) {
        if ($robots_base_content == '') {
            $robots_base_content = trim(file_get_contents($robots_base_path));
            $new_robots_content = $robots_base_content;
        } else {
            $new_robots_content = $robots_base_content;
        }
    }

    // L∆∞u v√†o ABSPATH/robots.txt
    if (file_put_contents($robots_main_path, $new_robots_content) !== false) {
        echo '<div class="notice notice-success"><p>ƒê√£ l∆∞u robots.txt th√†nh c√¥ng!</p></div>';

        // 
        if ($robots_base_content == '') {
            $robots_base_content = trim(file_get_contents($robots_base_path));
        }

        // Ki·ªÉm tra n·∫øu n·ªôi dung kh√°c v·ªõi base template th√¨ l∆∞u th√™m v√†o child
        if ($new_robots_content !== $robots_base_content) {
            // T·∫°o th∆∞ m·ª•c tmp n·∫øu ch∆∞a c√≥
            $child_tmp_dir = dirname($robots_child_path);
            if (!is_dir($child_tmp_dir)) {
                wp_mkdir_p($child_tmp_dir);
            }
            file_put_contents($robots_child_path, $new_robots_content);
        } else if (is_file($robots_child_path)) {
            unlink($robots_child_path);
        }

        $robots_content = $new_robots_content;
    } else {
        echo '<div class="notice notice-error"><p>L·ªói: Kh√¥ng th·ªÉ l∆∞u robots.txt!</p></div>';
    }
}
?>
<h2>Edit <a href="<?php echo get_home_url(); ?>/robots.txt" target="_blank">robots.txt</a></h2>
<form action="" method="post">
    <?php wp_nonce_field('save_robots_action', '_wpnonce_robots'); ?>
    <div class="text-center w99">
        <textarea name="robots_content" rows="<?php echo count(explode("\n", $robots_content)) + 1; ?>" class="large-text code" placeholder="Nh·∫≠p n·ªôi dung robots.txt..."><?php echo esc_textarea($robots_content); ?></textarea>
    </div>
    <br>
    <div>
        <button type="submit" name="save_robots" class="button button-primary button-large">L∆∞u robots.txt</button>
        <p><strong>Th·ª© t·ª± ∆∞u ti√™n ƒë·ªçc file:</strong></p>
        <ol>
            <li><?php echo str_replace(ABSPATH, '', $robots_main_path); ?></li>
            <li><?php echo str_replace(ABSPATH, '', $robots_child_path); ?></li>
            <li><?php echo str_replace(ABSPATH, '', $robots_base_path); ?></li>
        </ol>
    </div>
</form>
<!-- END Edit robots.txt -->